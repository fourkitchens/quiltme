<?php

use Drupal\node\NodeInterface;
use Drupal\media\Entity\Media;
use Drupal\file\Entity\File;

/**
 * @file
 * Primary module hooks for quiltme_picsart module.
 */

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function quiltme_picsart_node_presave(NodeInterface $node) {
  if ($node->bundle() == "user_submission") {
    $picsart = \Drupal::service('quiltme_picsart.connector');

    $image_media = Media::load($node->field_original_image->target_id);
    $image_file = File::load($image_media->field_media_image->target_id);
    $image_file_url = $image_file->createFileUrl();

    $options = [
      'image_url' => $image_file_url,
      'level' => 'l5',
      'email' => $node->field_user_email->value,
    ];

    $random_pattern_numbers = array_rand(range(0, 28), 4);

    foreach($random_pattern_numbers as $pattern_number) {
      //Add 0 in front of any single digit number
      $pattern_number = sprintf("%02d", $pattern_number);

      $pattern_url = "http://dev-4k-quiltme.pantheonsite.io/themes/custom/quiltme/images/patterns/pattern-{$pattern_number}.png";

      $options['reference_image_url'] = $pattern_url;
      $media_id = $picsart->getStyleTransferMediaId($options);
      $node->field_processed_images[] = ['target_id' => $media_id];
    }

  }
}
